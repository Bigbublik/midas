version: "3.8"
services:
  database:
    image: mongo
    environment:
      MONGO_INITDB_DATABASE: midas
    volumes:
      - "./db:/data/db"
      - "./etc/mongo/scripts:/docker-entrypoint-initdb.d"
  broker:
    image: nats-streaming:scratch
  proxy:
    image: envoyproxy/envoy-alpine:v1.16-latest
    command:
      - -c
      - /etc/midas/envoy.yaml
    volumes:
      - ./etc:/etc/midas
    environment:
      ENVOY_UID: 0
    depends_on:
      - service.symbol
      - service.historical
      - frontend
    ports:
      - 50000:50000
      - 50001:50001
  express:
    image: mongo-express
    environment:
      ME_CONFIG_MONGODB_SERVER: database
    ports:
      - 8081:8081
    depends_on:
      - database
  service.historical:
    build:
      context: ./backend
      dockerfile: devel.dockerfile
      args:
        - SERVICE=historical_service
    command:
      - -c
      - /etc/midas/midas.yml
    volumes:
      - ./etc:/etc/midas
      - ./backend:/opt/code
    depends_on:
      - database
      - broker
      - worker.historical.fetch
      - worker.historical.record
  service.symbol:
    build:
      context: ./backend
      dockerfile: devel.dockerfile
      args:
        - SERVICE=symbol_service
    command:
      - -c
      - /etc/midas/midas.yml
    volumes:
      - ./etc:/etc/midas
      - ./backend:/opt/code
    depends_on:
      - database
      - broker
  worker.historical.fetch:
    build:
      context: ./backend
      dockerfile: devel.dockerfile
      args:
        - SERVICE=historical_fetch_worker
    command:
      - -c
      - /etc/midas/midas.yml
    volumes:
      - ./etc:/etc/midas
      - ./backend:/opt/code
    depends_on:
      - database
      - broker
  worker.historical.record:
    build:
      context: ./backend
      dockerfile: devel.dockerfile
      args:
        - SERVICE=historical_record_worker
    command:
      - -c
      - /etc/midas/midas.yml
    volumes:
      - ./etc:/etc/midas
      - ./backend:/opt/code
    depends_on:
      - database
      - broker
  worker.trade.observer.binance:
    build:
      context: ./backend
      dockerfile: devel.dockerfile
      args:
        - SERVICE=observer_worker
    command:
      - -c
      - /etc/midas/midas.yml
      - -e
      - binance
    volumes:
      - ./etc:/etc/midas
      - ./backend:/opt/code
    depends_on:
      - database
      - broker
  frontend:
    build:
      context: frontend
    volumes:
      - ./frontend:/opt/code
      - /opt/code/node_modules
